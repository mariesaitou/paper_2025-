# Lobster SLiM simulation and post-processing

## Overview

This repository contains:

* A **SLiM (Eidos)** simulation for a spatially structured European lobster system with alternative MPA layouts and fishery regulation.
* An **R post-processing script** that converts SLiM TSV outputs into manuscript figures and tables.

## Reproducibility and large output files

Large intermediate TSV files generated by the SLiM simulations (e.g. population-, size-bin-, and trap-level outputs) are not included in this repository due to GitHub file size limits. These files are fully reproducible using the provided SLiM model (`lobster_patch_2.slim`), scenario table (`all.tsv`), and R post-processing script (`lobster_simu_script.R`).

All figures and tables in the manuscript can be regenerated by rerunning the simulation and analysis scripts following the instructions above.


## Repository structure

* `lobster_patch_2.slim`
  Main SLiM model (nonWF, 10 internal patches + 2 external patches).
* `lobster_simu_script.R`
  R script for post-processing SLiM outputs (Figures 2–5, Table 1).
* `lobster_patch_array.sh`
  Example batch/array submission script.
* `lobster_result.sh`
  Helper script for collecting results.
* `all.tsv`
  Scenario table mapping `cond` to dispersal and movement parameters.

## Quick start

### Run SLiM

```bash
slim \
  -d SCENARIO_TSV="all.tsv" \
  -d COND="Local" \
  -d MPA="block_up" \
  -d REP=1 \
  -d OUTFILE="all.tsv" \
  lobster_patch_2.slim
```

This produces:

* `all.tsv.popN.tsv`
* `all.tsv.natal.tsv`
* `all.tsv.sizebin.tsv`
* `all.tsv.agebin.tsv` (if enabled)
* `all.tsv.trap.tsv`

### R post-processing (`lobster_simu_script.R`)

The R script expects these input files in `base_dir` (default `.`):

* `all.tsv.popN.tsv`
* `all.tsv.sizebin.tsv`
* `all.tsv.natal.tsv`

Outputs are written to `./outputs/`.

Run:

```bash
Rscript lobster_simu_script.R
```

## Notes on large files

The TSV outputs can be large. For GitHub hosting, consider adding them to `.gitignore` and keeping only small example subsets.

Example `.gitignore`:

```gitignore
*.popN.tsv
*.natal.tsv
*.sizebin.tsv
*.agebin.tsv
*.trap.tsv
outputs/
```

## Model overview (SLiM / Eidos)

### System

* One species (European lobster)
* nonWF model, sexes enabled
* No genome (neutral placeholder only; mutation and recombination rates set to 0)

### Spatial structure

* 10 internal patches (`pos = 1..10`) arranged along a linear axis: upstream (1) → downstream (10)
* 2 external patches: upstream external (`pos = 0`) and downstream external (`pos = 11`)

### Recording rule

* Outputs are written **only for internal patches** (`pos = 1..10`)
* External patches may be harvested and may appear in the trap log, but are **not recorded** in `popN`, `natal`, `sizebin`, or `agebin`

### Individual state encoding

* Growth deviation and egg state are packed into `ind.tag`:

  * `tag = gInt * 3 + eggState`
  * `eggState ∈ {0,1,2}` (two-generation countdown)
* Body size (cm) is stored in `ind.tagF`

## Management and harvest rules

### MPA layouts

Internal patches are partitioned into 5 no-take (NT) and 5 open patches depending on `MPA_SCEN`:

* `block_up`: NT = {1..5}, Open = {6..10}
* `block_down`: Open = {1..5}, NT = {6..10}
* `alt_A`: NT = {1,3,5,7,9}, Open = {2,4,6,8,10}
* `alt_B`: Open = {1,3,5,7,9}, NT = {2,4,6,8,10}

### Fishing timing

* Fishery starts at `fishStartGen = 51`
* Regulation starts at `regStartGen = 101`

### Pre-regulation (generation < 101)

* If fishing is on, harvest occurs everywhere (including external patches)
* No slot-size or egg-protection rules

### Post-regulation (generation ≥ 101)

* No-take patches: closed (no harvest)
* Open patches: harvest only within slot size 25–32 cm
* Egg-bearing females are protected if `protectEggFemales = T`
* External patches are treated as open-like (slot and egg rules apply) but remain unrecorded except in the trap log

### Trap effort adaptation

* After regulation, the number of traps (`nTrap`) increases multiplicatively (`effMult`) if harvest is below a target estimated from pre-regulation harvest

## Demography and density dependence

### Annual cycle (early)

* Reset `fitnessScaling` for all alive individuals
* Early mortality for age 0 using `larvaSurv`
* Senescence via Gompertz survival: `S = exp(-h0 * exp(g * age))`
* Adult movement among neighboring internal patches with probability `mAdult_L`

### Density dependence (per subpopulation)

* Beverton–Holt factor:

  * `dd = 1 / (1 + dd_a * (N / K))`
* Additional over-capacity crash when `N > K`:

  * `overcap = exp(-gammaOverCap * (N / K - 1))`
  * Optionally floored by `minRecruitFrac`

### Growth

* Von Bertalanffy size update
* Individual-specific growth modifier derived from `gInt`

## Reproduction (nonWF)

* Females reproduce stochastically with probability `pBreed_L`
* Maturity gate:

  * Size-based (logistic with `L50` and `matSlope`) if `useSizeMaturity = T`, or
  * Minimum age `minAge_L` otherwise
* Mating occurs within the same patch
* Larval production: `rpois(meanLarvae)` scaled by `dd_factor * overcap_factor`
* Larval dispersal along the 12-patch line (`pos = 0..11`) using:

  * Downstream bias `larvaBias`
  * Mean distance scale `larvaMeanDist`

## Outputs

All output files share a base name `OUTFILE` (default `lobster_slim_test.tsv`) and are written as TSV.

### Run parameters

* Written once per replicate as comment lines (`# ...`) appended to `OUTFILE`

### Population size time series (`*.popN.tsv`)

* Internal patches only
* Written every 10 generations
* Columns: `cond, mpa, rep, generation, pos, area, N`

### Natal-origin matrix snapshots (`*.natal.tsv`)

* Written at snapshot generations: 100, 120, 140, 160, 200
* For each internal `currPos = 1..10`, counts by `bornPos = 0..11`
* Columns: `cond, mpa, rep, generation, bornPos, currPos, n, prop`

### Size-bin snapshots (`*.sizebin.tsv`)

* Written at snapshot generations
* Size bins: 0–50 cm in 5 cm steps
* By internal `pos`, area (`open` / `no_take`), and sex
* `prop` normalized by all alive individuals in the patch
* Columns: `cond, mpa, rep, generation, pos, area, sex, bin_lo, bin_hi, n, prop`

### Age-bin snapshots (`*.agebin.tsv`)

* Written at snapshot generations
* Age bins: 0–40
* By internal `pos`, area, and sex
* `prop` normalized by all alive individuals in the patch
* Columns: `cond, mpa, rep, generation, pos, area, sex, age, n, prop`

### Trap log (`*.trap.tsv`)

* Written every `trapEvery = 20` generations
* Records capture and harvest decisions for debugging slot size and egg protection
* Columns: `cond, mpa, rep, generation, pos, area, sex, size, egg, captured, harvested, reason`

## R post-processing (`lobster_simu_script.R`)

### Requirements

#### R packages

The script uses the following packages:

* `readr`
* `dplyr`
* `tidyr`
* `stringr`
* `forcats`
* `ggplot2`

Install (if needed):

```r
install.packages(c("readr","dplyr","tidyr","stringr","forcats","ggplot2"))
```

### How to run

From the repository root (where the input files are located):

```bash
Rscript make_figs_tables.R
```

On completion, the script prints the absolute path to the `outputs/` directory.

### Input files

#### 1) `all.tsv.popN.tsv`

Population size summaries per generation. Fields used by the script include:

* `generation`
* `rep`
* `cond`
* `mpa`
* `area`
* `N`

Within each replicate, population sizes are summed across patches before computing the mean and standard error across replicates.

#### 2) `all.tsv.sizebin.tsv`

Counts of alive individuals by size bin and sex. Fields used include:

* `generation`
* `rep`
* `cond`
* `mpa`
* `area`
* `sex`
* `bin_lo`, `bin_hi`
* `n`

#### 3) `all.tsv.natal.tsv`

Natal-origin counts by current patch. Fields used include:

* `generation`
* `cond`
* `mpa`
* `currPos`
* `bornPos`
* `n`

Lines beginning with `#` are treated as comments and ignored.

### What the script produces

#### Figure 2: Total population size time series

* Facets: `cond` (rows) × `mpa` (columns)
* Lines and ribbons: Open vs No Take areas
* Vertical dashed lines indicate:

  * Fishing onset: `fish_gen = 51`
  * Regulation start: `reg_gen = 101`

Output:

* `outputs/fig2_pop_timeseries.png`

#### Figure 3: Patch-level population size distributions (generation 140)

* Boxplots of population size by patch (`pos`)
* Facets: `cond` × `mpa`
* Generated at `GEN_FIG3 = 140`

Output:

* `outputs/fig3_patch_boxplots_gen140.png`

#### Figure 4: Population pyramid (generation 200, Dispersal scenario only)

* Uses `sizebin` data
* Filtered to `cond == "Dispersal"` and `generation == 200`
* Females plotted positive (right), males negative (left)
* Size threshold at 25 cm marked with a dashed line
* Facets: area (Open vs No-take) × `mpa`
* Colors:

  * ≥25 cm: fixed colors by sex
  * <25 cm: grayscale

Output:

* `outputs/fig4_pyramid_gen200_dispersal.png`

#### Figure 5: Natal origin composition (generation 140)

* Stacked proportions within each current patch (`currPos`)
* `bornPos` values 0 and 11 are pooled as `Outside`
* Facets: `cond` × `mpa`

Output:

* `outputs/fig5_natal_composition_gen140.png`

#### Table 1: Sex-specific differences in abundance (generation 200)

* Replicate-level totals are computed by sex
* Differences (`M - F`) are tested using a one-sided Wilcoxon signed-rank test:

  * `alternative = "less"` (tests whether M < F)
* Size classes:

  * `<25` (bins with `bin_lo < 25`)
  * `25–35` (bins with `25 <= bin_lo < 35`)
* Multiple testing correction: Benjamini–Hochberg FDR
* Only rows with `p_fdr < 0.01` are retained

Output:

* `outputs/table1_sex_diff_gen200.csv`

### Parameter settings you may want to change

At the top of the script:

* `base_dir` (default `"."`)
* `base_tsv` (default `"all.tsv"`)

Generation constants:

* `GEN_FIG3 = 140`
* `GEN_FIG5 = 140`
* `GEN_FIG4 = 200`

Event markers for Figure 2:

* `fish_gen = 51`
* `reg_gen = 101`

### Naming conventions

The script normalizes MPA layout labels as follows:

* `block_up` → `NT_OP`
* `block_down` → `OP_NT`
* `alt_A` → `NONO`
* `alt_B` → `ONON`

If input files already use `NT_OP`, `OP_NT`, `NONO`, or `ONON`, they are kept as-is.
